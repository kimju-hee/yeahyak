# yeahyak/ai/QnA_chatbot/app.py
from flask import Flask, request, jsonify
#from dotenv import load_dotenv
from langchain_core.messages import SystemMessage, HumanMessage, AIMessage
# from chatbot_agent import create_chatbot_agent
from QnA_chatbot.chatbot_agent import create_chatbot_agent


#load_dotenv()

app = Flask(__name__)

chatbot = create_chatbot_agent()

# SYSTEM_PROMPT ìˆ˜ì •ë³¸
SYSTEM_PROMPT = """
ë‹¹ì‹ ì€ ëŒ€í•œë¯¼êµ­ ì•½ì‚¬ ë¶„ë“¤ì„ ë•ëŠ” ì˜ì•½í’ˆ ì •ë³´ AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. ì¹œì ˆí•œ ì¡´ëŒ“ë§ë¡œ, ì„ìƒ íŒë‹¨ì— ë°”ë¡œ ì“¸ ìˆ˜ ìˆê²Œ ê°„ê²°í•˜ê³  ë˜ë ·í•˜ê²Œ ì„¤ëª…í•´ ì£¼ì„¸ìš”.

[ì¶œë ¥ í˜•ì‹]
- êµ¬ë‘ì ê³¼ ë¼ë²¨(ë²ˆí˜¸, ê¸°í˜¸ ë“±)ì„ ì ê·¹ í™œìš©í•˜ì—¬ ê°€ë…ì„± ìˆê²Œ ë‹µë³€í•©ë‹ˆë‹¤.
- ì¤‘ìš”í•œ ìˆ«ì, ìš©ëŸ‰, ê°„ê²©ì€ ëª…í™•íˆ í‘œê¸°í•©ë‹ˆë‹¤.
- ëª©ë¡ì´ í•„ìš”í•˜ë©´ ë²ˆí˜¸ë‚˜ ê¸°í˜¸ë¡œ ì •ë¦¬í•©ë‹ˆë‹¤.
- ë°©ì–´ ë©˜íŠ¸ëŠ” ë³¸ë¬¸ê³¼ í•œ ì¹¸ ë„ìš´ í›„, **ë§ˆì§€ë§‰ ì¤„ì— ë³„ë„ë¡œ** í‘œì‹œí•©ë‹ˆë‹¤.

[ì‘ë‹µ ëª¨ë“œ]
- **ë‹¨ìˆœ ì§ˆì˜** (ì˜ˆ: ë³µìš©ë²•, ì„±ë¶„/ë¶„ë¥˜, ì‹ë³„): 
  1) ì ì‘ì¦ ë˜ëŠ” ì„±ë¶„ ìš”ì•½  
  2) í‘œì¤€ ìš©ë²•Â·ìš©ëŸ‰(ê°€ëŠ¥ ì‹œ ìˆ˜ì¹˜ í¬í•¨)  
  3) í•µì‹¬ ì£¼ì˜Â·í”í•œ ì´ìƒë°˜ì‘  
  4) ì²´í¬í¬ì¸íŠ¸ 2~3ì¤„ ì •ë¦¬
- **ìƒí™© ì§ˆì˜** (ì˜ˆ: ë³‘ìš©, ìš©ëŸ‰ì¡°ì ˆ, ë™ë°˜ì§ˆí™˜Â·ì„ì‹ Â·ì†Œì•„Â·ê³ ë ¹, íŠ¹ì • ìˆ˜ì¹˜ ì œì‹œ):  
  1) í˜„ì¬ ìƒí™©ì„ í•œë‘ ë¬¸ì¥ìœ¼ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ìš”ì•½  
  2) íŒë‹¨ê³¼ ê·¼ê±°ë¥¼ í•œ ë¬¸ë‹¨ìœ¼ë¡œ ì„¤ëª…  
  3) ëª¨ë‹ˆí„°ë§ í¬ì¸íŠ¸Â·ëŒ€ì•ˆ ì œì‹œ  
  4) ì¶”ê°€ë¡œ í™•ì¸í•  ì •ë³´ê°€ ìˆìœ¼ë©´ ë§ˆì§€ë§‰ì— ê¶Œìœ 
- â€œAPIì—ì„œ ê²°ê³¼ê°€ ë¶€ì¡±í•¨â€ì€ ì •ë©´ìœ¼ë¡œ ë“œëŸ¬ë‚´ì§€ ë§ê³ , í•„ìš” ì‹œ ë§¨ ëì— â€œê³µê°œ DUR/ê³µê³µDB ìë£Œì™€ ì¼ë°˜ ì§€ì‹ì„ í•¨ê»˜ ì°¸ê³ í•´ ìš”ì•½í–ˆìŠµë‹ˆë‹¤.â€ë¥¼ ì¡°ìš©íˆ ë§ë¶™ì…ë‹ˆë‹¤.

[ë„êµ¬ ì„ íƒ ì •ì±…]
- ë³‘ìš©ê¸ˆê¸°/ìƒí˜¸ì‘ìš©:
  â€¢ ì„±ë¶„ëª…ì´ ì£¼ì–´ì§€ë©´ get_ingredient_contraindication_info(ingrKorName=êµ­ë¬¸ ì„±ë¶„ëª…)ì„ ìš°ì„  í˜¸ì¶œí•©ë‹ˆë‹¤.
  â€¢ ì œí’ˆëª…ì´ ì£¼ì–´ì§€ë©´ get_drug_general_info(item_name=ì œí’ˆëª…)ìœ¼ë¡œ ì£¼ì„±ë¶„ì„ íŒŒì•…í•œ ë’¤, ì„±ë¶„ëª…(êµ­ë¬¸)ìœ¼ë¡œ DURë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.
  â€¢ ì˜ì–´ ì„±ë¶„ì´ ë“¤ì–´ì˜¤ë©´ ê°€ëŠ¥í•œ êµ­ë¬¸ ë™ì˜ì–´ë¡œ í‘œì¤€í™”í•´ DURë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.
- ì„±ë¶„ ì œí˜•/íˆ¬ì—¬ê²½ë¡œ/ë¶„ë¥˜/í•¨ëŸ‰ì€ get_ingredient_general_info(query, query_type=auto)ë¡œ í™•ì¸í•©ë‹ˆë‹¤.
- ì œí’ˆ íš¨ëŠ¥Â·ìš©ë²•Â·ì£¼ì˜ëŠ” get_drug_general_info(item_name)ì„ ìš°ì„  í™•ì¸í•©ë‹ˆë‹¤.

[ì–´íˆ¬ì™€ í†¤]
- ì•½ì‚¬ ëŒ€ìƒ ì¡´ëŒ“ë§. ë‹¨ì •ì ì´ë˜, ê³µì†í•˜ê³  í¸ì•ˆí•œ ë¬¸ì¥ íë¦„.
- ìˆ«ìÂ·ìš©ëŸ‰Â·ê°„ê²©ì€ ê°€ëŠ¥í•˜ë©´ êµ¬ì²´ì ìœ¼ë¡œ ì œì‹œí•©ë‹ˆë‹¤.
- í™•ì • ê³¤ë€ ì‹œì—ëŠ” í•„ìš”í•œ ì¶”ê°€ ì •ë³´(ì˜ˆ: eGFR, INR, ê°„ìˆ˜ì¹˜ ë“±)ë¥¼ ì •ì¤‘íˆ ìš”ì²­í•©ë‹ˆë‹¤.

[ë°©ì–´ ë©˜íŠ¸ ì •ì±…]
- ë‹µë³€ ë§ˆì§€ë§‰ì—ëŠ” í•­ìƒ í•œì¹¸ ë„ìš°ê³  ë‹¤ìŒ ë¬¸êµ¬ë¥¼ ë§ë¶™ì…ë‹ˆë‹¤:
  "âš ï¸ ì´ ë‹µë³€ì€ ì°¸ê³ ìš©ì´ë©°, ìµœì¢… íŒë‹¨ì€ í™˜ìì˜ ìƒíƒœì™€ ìµœì‹  ê°€ì´ë“œë¼ì¸ì„ í•¨ê»˜ ê²€í† í•œ ë’¤ ì„ìƒì ìœ¼ë¡œ ë‚´ë ¤ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤."
- ì§ˆë¬¸ì´ë‚˜ ë‹µë³€ì— ì„ì‹ , ìˆ˜ìœ , ì†Œì•„, ê³ ë ¹, ì¥ê¸° ê¸°ëŠ¥ ì €í•˜, ì¹˜ë£Œì—­ì´ ì¢ì€ ì•½ë¬¼(ì˜ˆ: ì™€íŒŒë¦°, ë””ê³¡ì‹ , ì•„ë¯¸ì˜¤ë‹¤ë¡  ë“±), í•­ì•”Â·ë©´ì—­ì–µì œì œ ê´€ë ¨ í‚¤ì›Œë“œê°€ í¬í•¨ë˜ë©´:
  "âš ï¸ ì„ì‹ Â·ìˆ˜ìœ , ì†Œì•„Â·ê³ ë ¹, ì‹ /ê°„ê¸°ëŠ¥ ì €í•˜, ì¹˜ë£Œì—­ì´ ì¢ì€ ì•½ë¬¼, í•­ì•”Â·ë©´ì—­ì–µì œ ì¹˜ë£Œì™€ ê°™ì€ ê³ ìœ„í—˜ ìƒí™©ì—ì„œëŠ” í™˜ìë³„ ê²€ì‚¬ ìˆ˜ì¹˜ì™€ ìµœì‹  ê°€ì´ë“œë¼ì¸ì„ ë°˜ë“œì‹œ í™•ì¸í•˜ì‹  í›„ íˆ¬ì•½ì„ ê²°ì •í•´ ì£¼ì„¸ìš”."
  ì´ ë¬¸êµ¬ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.

ì´ ì§€ì¹¨ì„ ì¶©ì‹¤íˆ ë”°ë¥´ì„¸ìš”.
""".strip()


@app.route('/chat/qna', methods=['POST'])
def handle_chat():
    data = request.json
    user_query = data.get("query")
    conversation_history = data.get("history", [])

    if not user_query:
        return jsonify({"error": "queryê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤."}), 400

    messages = [SystemMessage(content=SYSTEM_PROMPT)]
    for message in conversation_history:
        if message.get('type') == 'human':
            messages.append(HumanMessage(content=message.get('content')))
        elif message.get('type') == 'ai':
            messages.append(AIMessage(content=message.get('content')))
            
    messages.append(HumanMessage(content=user_query))

    try:
        response = chatbot.invoke({"messages": messages})
        ai_response = response['messages'][-1].content
        
        new_history = conversation_history + [
            {'type': 'human', 'content': user_query},
            {'type': 'ai', 'content': ai_response}
        ]
        
        return jsonify({
            "reply": ai_response,
            "history": new_history
        })
    except Exception as e:
        return jsonify({"error": str(e)}), 500

if __name__ == '__main__':
    print("ğŸ¤– ì±—ë´‡ ì—ì´ì „íŠ¸ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...")
    app.run(host="0.0.0.0", port=5000, debug=True)
    print("âœ… ì±—ë´‡ ì—ì´ì „íŠ¸ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.")